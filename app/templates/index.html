<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SunPixel - å›¾ç‰‡è½¬Minecraftç»“æ„</title>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --info-color: #3498db;
            --bg-color: #f8f9fa;
            --text-color: #2c3e50;
            --text-light: #7f8c8d;
            --border-color: #e0e0e0;
            --console-bg: #1a1a1a;
            --console-text: #e0e0e0;
            --console-success: #27ae60;
            --console-error: #e74c3c;
            --console-warning: #f39c12;
            --console-info: #3498db;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-color);
            line-height: 1.6;
        }
        
        .container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 95vh;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 35px 40px;
            text-align: center;
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="1"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
        }
        
        .header-content {
            position: relative;
            z-index: 1;
        }
        
        .header h1 {
            font-size: 3em;
            margin-bottom: 12px;
            background: linear-gradient(45deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header p {
            opacity: 0.95;
            font-size: 1.3em;
            font-weight: 300;
        }
        
        .version-badge {
            position: absolute;
            top: 15px;
            right: 15px;
            background: linear-gradient(135deg, #ff6b6b, #ff9ff3);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
        }
        
        .settings-panel {
            padding: 35px 40px;
            border-bottom: 3px solid var(--border-color);
            flex-shrink: 0;
            background: var(--bg-color);
        }
        
        .settings-content {
            max-width: 1000px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 35px;
            align-items: start;
        }
        
        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .config-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .upload-area {
            border: 3px dashed var(--primary-color);
            border-radius: 15px;
            padding: 35px 25px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .upload-area::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(52, 152, 219, 0.1), transparent);
            transition: left 0.5s;
        }
        
        .upload-area:hover::before {
            left: 100%;
        }
        
        .upload-area:hover {
            border-color: var(--primary-dark);
            background: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(52, 152, 219, 0.15);
        }
        
        .upload-area.dragover {
            border-color: var(--success-color);
            background: #d5f4e6;
        }
        
        .upload-icon {
            font-size: 56px;
            color: var(--primary-color);
            margin-bottom: 18px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }
        
        .upload-area h3 {
            font-size: 1.4em;
            margin-bottom: 10px;
            color: var(--text-color);
            font-weight: 600;
        }
        
        .upload-area p {
            color: var(--text-light);
            font-size: 1em;
        }
        
        .preview {
            text-align: center;
            display: none;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: 2px solid var(--border-color);
        }
        
        .preview img {
            max-width: 100%;
            max-height: 180px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 0;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1em;
        }
        
        .size-inputs {
            display: flex;
            gap: 15px;
        }
        
        .size-inputs input {
            flex: 1;
        }
        
        .format-select {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .format-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .format-option:hover {
            border-color: var(--primary-color);
            background: #f0f8ff;
        }
        
        .format-option.selected {
            border-color: var(--primary-color);
            background: #e3f2fd;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
        }
        
        .format-option input {
            width: auto;
            transform: scale(1.2);
        }
        
        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
            color: var(--text-color);
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .blocks-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
            max-height: 140px;
            overflow-y: auto;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 16px;
            background: white;
        }
        
        .block-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            padding: 6px 8px;
            border-radius: 6px;
            transition: background 0.2s ease;
            color: var(--text-color);
        }
        
        .block-option:hover {
            background: #f0f8ff;
        }
        
        .block-option input {
            width: auto;
            transform: scale(1.2);
        }
        
        .action-section {
            grid-column: 1 / -1;
            margin-top: 15px;
        }
        
        .btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 12px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(52, 152, 219, 0.4);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn:disabled::before {
            display: none;
        }
        
        .console-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
        }
        
        .console-header {
            background: #2c3e50;
            color: white;
            padding: 18px 35px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .console-header h3 {
            margin: 0;
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .console-controls {
            display: flex;
            gap: 12px;
        }
        
        .console-controls button {
            background: #34495e;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .console-controls button:hover {
            background: #4a6572;
            transform: translateY(-1px);
        }
        
        .console {
            background: var(--console-bg);
            color: var(--console-text);
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            flex: 1;
            overflow-y: auto;
            padding: 25px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .console-content {
            white-space: pre-wrap;
            line-height: 1.5;
            min-height: 100%;
            font-size: 14px;
        }
        
        .console-line {
            margin-bottom: 8px;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .console-line.error {
            color: var(--console-error);
        }
        
        .console-line.success {
            color: var(--console-success);
        }
        
        .console-line.warning {
            color: var(--console-warning);
        }
        
        .console-line.info {
            color: var(--console-info);
        }
        
        .progress-info {
            background: rgba(52, 152, 219, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
        
        .progress-stage {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1em;
            display: block;
            margin-bottom: 4px;
        }
        
        .progress-message {
            color: var(--text-color);
            font-size: 0.95em;
        }
        
        .github-link {
            text-align: center;
            padding: 20px;
            background: var(--bg-color);
            border-radius: 0 0 20px 20px;
            flex-shrink: 0;
        }
        
        .github-link p {
            color: var(--text-color);
            font-size: 1em;
        }
        
        .github-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            transition: color 0.3s ease;
        }
        
        .github-link a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }
        
        .file-input {
            display: none;
        }
        
        .download-section {
            display: none;
            text-align: center;
            padding: 20px;
            background: rgba(39, 174, 96, 0.1);
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid var(--success-color);
        }
        
        .download-btn {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(39, 174, 96, 0.3);
        }
        
        /* å¼¹çª—æ ·å¼ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            animation: fadeIn 0.3s forwards;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
            transform: translateY(20px);
            animation: slideUp 0.3s forwards;
        }
        
        .modal-header {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .modal-header h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .modal-body {
            line-height: 1.8;
            color: var(--text-color);
        }
        
        .update-list {
            list-style: none;
            padding: 0;
            margin: 20px 0;
        }
        
        .update-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .update-list li::before {
            content: 'âœ¨';
        }
        
        .modal-footer {
            text-align: center;
            margin-top: 30px;
        }
        
        .modal-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            to { transform: translateY(0); }
        }
        
        @media (max-width: 768px) {
            .settings-content {
                grid-template-columns: 1fr;
            }
            
            .container {
                height: auto;
                min-height: 95vh;
            }
            
            .main-content {
                overflow: visible;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .header p {
                font-size: 1.1em;
            }
            
            .format-select {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- æ›´æ–°å…¬å‘Šå¼¹çª— -->
    <div class="modal-overlay" id="updateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ğŸ‰ SunPixel æ›´æ–°å…¬å‘Š V-1.3.1</h2>
                <p>æ„Ÿè°¢æ‚¨ä½¿ç”¨ SunPixelï¼</p>
            </div>
            <div class="modal-body">
                <p>æœ¬æ¬¡æ›´æ–°å¸¦æ¥äº†ä»¥ä¸‹æ”¹è¿›å’Œæ–°åŠŸèƒ½ï¼š</p>
                <ul class="update-list">
                    <li>æ–°å¢æ–‡ä»¶å¤¹ç»“æ„ï¼Œä»£ç æ›´åŠ æ¨¡å—åŒ–</li>
                    <li>æ–°å¢é…ç½®æ–‡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒè‡ªå®šä¹‰è®¾ç½®</li>
                    <li>æ–°å¢å¤šè¯­è¨€æ”¯æŒï¼ˆä¸­è‹±æ–‡ï¼‰</li>
                    <li>ä¼˜åŒ–ç»ˆç«¯æ–‡å­—æ˜¾ç¤ºï¼Œå†…å®¹æ›´ç”ŸåŠ¨</li>
                    <li>æ–°å¢æ–‡ä»¶è¾“å‡ºç›®å½•è‡ªå®šä¹‰é…ç½®</li>
                    <li>æ–°å¢å¤šæ–‡ä»¶æ ¼å¼è½¬æ¢æ”¯æŒ</li>
                    <li>å°†ä»£ç æ‹†åˆ†ä¸ºç§¯æœ¨å½¢å¼ï¼Œæ¯ä¸ªä»£ç è´Ÿè´£ä¸€ä¸ªéƒ¨åˆ†</li>
                </ul>
                <p><strong>æ–°å¢æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š</strong></p>
                <ul class="update-list">
                    <li><strong>.schem</strong> - æ ‡å‡†ç»“æ„æ–‡ä»¶</li>
                    <li><strong>.json [RunAway]</strong> - RunAwayæ ¼å¼ç»“æ„</li>
                    <li><strong>.litematic</strong> - Litematicaæ¨¡ç»„ç»“æ„</li>
                </ul>
                <p>å¸Œæœ›æ–°ç‰ˆæœ¬èƒ½ä¸ºæ‚¨å¸¦æ¥æ›´å¥½çš„ä½¿ç”¨ä½“éªŒï¼</p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn" id="closeUpdateModal">å¼€å§‹ä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <!-- éšè—çš„ä¸‹è½½iframe -->
    <iframe id="downloadFrame" style="display: none; position: absolute; left: -9999px;"></iframe>

    <div class="container">
        <div class="header">
            <div class="version-badge">V-1.3.1</div>
            <div class="header-content">
                <h1>SunPixel</h1>
                <p>å°†å›¾ç‰‡è½¬æ¢ä¸º Minecraft ç»“æ„æ–‡ä»¶</p>
            </div>
        </div>
        
        <div class="main-content">
            <!-- è®¾ç½®é¢æ¿ -->
            <div class="settings-panel">
                <div class="settings-content">
                    <div class="upload-section">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-icon">ğŸ“</div>
                            <h3>ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤åŒºåŸŸ</h3>
                            <p>æ”¯æŒ PNG å’Œ JPG æ ¼å¼</p>
                            <input type="file" id="fileInput" class="file-input" accept=".png,.jpg,.jpeg">
                        </div>
                        
                        <div class="preview" id="preview">
                            <img id="previewImage" src="" alt="å›¾ç‰‡é¢„è§ˆ">
                        </div>
                    </div>
                    
                    <div class="config-section">
                        <div class="form-group">
                            <label for="width">å®½åº¦ (æ–¹å—æ•°)</label>
                            <input type="number" id="width" placeholder="ç•™ç©ºä½¿ç”¨åŸå›¾å°ºå¯¸" min="1" max="512">
                        </div>
                        
                        <div class="form-group">
                            <label for="height">é«˜åº¦ (æ–¹å—æ•°)</label>
                            <input type="number" id="height" placeholder="ç•™ç©ºä½¿ç”¨åŸå›¾å°ºå¯¸" min="1" max="512">
                        </div>
                        
                        <div class="form-group">
                            <label>è¾“å‡ºæ ¼å¼</label>
                            <div class="format-select">
                                <label class="format-option selected">
                                    <input type="radio" name="format" value="schem" checked>
                                    <span>.schem</span>
                                </label>
                                <label class="format-option">
                                    <input type="radio" name="format" value="json">
                                    <span>.json</span>
                                </label>
                                <label class="format-option">
                                    <input type="radio" name="format" value="litematic">
                                    <span>.litematic</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>é€‰æ‹©æ–¹å—ç±»å‹</label>
                            <div class="blocks-container" id="blocksContainer">
                                <!-- æ–¹å—é€‰é¡¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                        
                        <div class="action-section">
                            <button type="button" class="btn" id="convertBtn" disabled>
                                <span id="btnText">ğŸš€ å¼€å§‹è½¬æ¢</span>
                            </button>
                            
                            <div class="download-section" id="downloadSection">
                                <p>âœ… è½¬æ¢å®Œæˆï¼ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ä¸‹è½½æ–‡ä»¶</p>
                                <a href="#" class="download-btn" id="downloadBtn" download>ğŸ“¥ ä¸‹è½½ç»“æ„æ–‡ä»¶</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æ§åˆ¶å°é¢æ¿ -->
            <div class="console-panel">
                <div class="console-header">
                    <h3>ğŸ“‹ æ§åˆ¶å°è¾“å‡º</h3>
                    <div class="console-controls">
                        <button id="clearConsoleBtn">æ¸…ç©ºæ§åˆ¶å°</button>
                        <button id="copyLogsBtn">å¤åˆ¶æ—¥å¿—</button>
                    </div>
                </div>
                <div class="console" id="console">
                    <div class="console-content" id="consoleContent">
                        <div class="console-line info">ğŸš€ SunPixel Webç‰ˆ V-1.3.1 å·²å°±ç»ª</div>
                        <div class="console-line info">ğŸ“ è¯·ä¸Šä¼ å›¾ç‰‡å¹¶è®¾ç½®å‚æ•°å¼€å§‹è½¬æ¢</div>
                        <div class="console-line info">ğŸ’¡ æç¤º: æ”¯æŒ.schemã€.jsonã€.litematicä¸‰ç§æ ¼å¼</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="github-link">
            <p>å¼€æºé¡¹ç›®: <a href="https://github.com/suibian-sun/SunPixel" target="_blank">GitHub - SunPixel</a> | ä½œè€…: suibian-sun | ç‰ˆæœ¬: V-1.3.1</p>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentFile = null;
        let conversionInProgress = false;
        let progressInterval = null;
        let currentTaskId = null;
        
        // DOM å…ƒç´ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('preview');
        const previewImage = document.getElementById('previewImage');
        const blocksContainer = document.getElementById('blocksContainer');
        const convertBtn = document.getElementById('convertBtn');
        const btnText = document.getElementById('btnText');
        const consoleElement = document.getElementById('console');
        const consoleContent = document.getElementById('consoleContent');
        const clearConsoleBtn = document.getElementById('clearConsoleBtn');
        const copyLogsBtn = document.getElementById('copyLogsBtn');
        const downloadSection = document.getElementById('downloadSection');
        const downloadBtn = document.getElementById('downloadBtn');
        const updateModal = document.getElementById('updateModal');
        const closeUpdateModalBtn = document.getElementById('closeUpdateModal');
        const formatOptions = document.querySelectorAll('.format-option');
        const downloadFrame = document.getElementById('downloadFrame');
        
        // æ˜¾ç¤ºæ›´æ–°å…¬å‘Š
        setTimeout(() => {
            updateModal.style.display = 'flex';
        }, 500);
        
        // å…³é—­æ›´æ–°å…¬å‘Š
        closeUpdateModalBtn.addEventListener('click', () => {
            updateModal.style.display = 'none';
        });
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­å¼¹çª—
        updateModal.addEventListener('click', (e) => {
            if (e.target === updateModal) {
                updateModal.style.display = 'none';
            }
        });
        
        // æ ¼å¼é€‰æ‹©äº¤äº’
        formatOptions.forEach(option => {
            const radio = option.querySelector('input');
            radio.addEventListener('change', () => {
                formatOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
            });
        });
        
        // äº‹ä»¶ç›‘å¬å™¨
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        convertBtn.addEventListener('click', handleConversion);
        clearConsoleBtn.addEventListener('click', clearConsole);
        copyLogsBtn.addEventListener('click', copyLogs);
        downloadBtn.addEventListener('click', handleDownload);
        
        // åŠ è½½å¯ç”¨çš„æ–¹å—ç±»å‹
        loadAvailableBlocks();
        
        // æ§åˆ¶å°è¾“å‡ºå‡½æ•°
        function logToConsole(message, type = 'info') {
            const line = document.createElement('div');
            line.className = `console-line ${type}`;
            line.textContent = message;
            consoleContent.appendChild(line);
            consoleElement.scrollTop = consoleElement.scrollHeight;
        }
        
        function clearConsole() {
            consoleContent.innerHTML = '';
            logToConsole('ğŸ”„ æ§åˆ¶å°å·²æ¸…ç©º', 'info');
            logToConsole('ğŸš€ SunPixel Webç‰ˆ V-1.3.1 å·²å°±ç»ª', 'info');
            logToConsole('ğŸ“ è¯·ä¸Šä¼ å›¾ç‰‡å¹¶è®¾ç½®å‚æ•°å¼€å§‹è½¬æ¢', 'info');
        }
        
        function copyLogs() {
            const logs = consoleContent.textContent;
            navigator.clipboard.writeText(logs).then(() => {
                logToConsole('ğŸ“‹ æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(err => {
                logToConsole('âŒ å¤åˆ¶å¤±è´¥: ' + err, 'error');
            });
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        }
        
        function handleFile(file) {
            if (!file.type.match('image.*')) {
                logToConsole('âŒ è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ (PNG æˆ– JPG)', 'error');
                return;
            }
            
            currentFile = file;
            
            // æ˜¾ç¤ºé¢„è§ˆ
            const reader = new FileReader();
            reader.onload = function(e) {
                previewImage.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            // å¯ç”¨è½¬æ¢æŒ‰é’®
            convertBtn.disabled = false;
            logToConsole('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ: ' + file.name, 'success');
            logToConsole('ğŸ“ è¯·è®¾ç½®å‚æ•°å¹¶ç‚¹å‡»"å¼€å§‹è½¬æ¢"', 'info');
            
            // éšè—ä¸‹è½½åŒºåŸŸ
            downloadSection.style.display = 'none';
        }
        
        async function loadAvailableBlocks() {
            try {
                const response = await fetch('/api/blocks');
                const blocks = await response.json();
                
                blocksContainer.innerHTML = '';
                blocks.forEach(block => {
                    const label = document.createElement('label');
                    label.className = 'block-option';
                    label.innerHTML = `
                        <input type="checkbox" name="blocks" value="${block}" checked>
                        <span>${block}</span>
                    `;
                    blocksContainer.appendChild(label);
                });
                
                // é»˜è®¤é€‰æ‹© wool å’Œ concrete
                if (blocks.includes('wool') && blocks.includes('concrete')) {
                    const woolCheckbox = document.querySelector('input[value="wool"]');
                    const concreteCheckbox = document.querySelector('input[value="concrete"]');
                    if (woolCheckbox) woolCheckbox.checked = true;
                    if (concreteCheckbox) concreteCheckbox.checked = true;
                }
                
                logToConsole('âœ… æ–¹å—ç±»å‹åŠ è½½å®Œæˆ', 'success');
            } catch (error) {
                logToConsole('âŒ åŠ è½½æ–¹å—ç±»å‹å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        // è½®è¯¢è¿›åº¦
        function startProgressPolling(taskId) {
            progressInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/progress/${taskId}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        logToConsole('âŒ ' + data.error, 'error');
                        stopProgressPolling();
                        return;
                    }
                    
                    // æ›´æ–°æ§åˆ¶å°æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯
                    if (data.message && !data.message.includes('å¤„ç†åƒç´ ')) {
                        const progressInfo = document.createElement('div');
                        progressInfo.className = 'progress-info';
                        progressInfo.innerHTML = `
                            <span class="progress-stage">${data.stage || 'å¤„ç†ä¸­'} - ${data.progress}%</span>
                            <span class="progress-message">${data.message}</span>
                        `;
                        consoleContent.appendChild(progressInfo);
                        consoleElement.scrollTop = consoleElement.scrollHeight;
                    }
                    
                    // æ˜¾ç¤ºæœ€æ–°æ—¥å¿—
                    if (data.logs && data.logs.length > 0) {
                        const existingLogs = Array.from(consoleContent.querySelectorAll('.console-line')).map(el => el.textContent);
                        data.logs.forEach(log => {
                            if (!existingLogs.includes(log)) {
                                const type = log.includes('âŒ') ? 'error' : 
                                           log.includes('âœ…') ? 'success' : 
                                           log.includes('âš ï¸') ? 'warning' : 'info';
                                logToConsole(log, type);
                            }
                        });
                    }
                    
                    if (!data.is_running && progressInterval) {
                        stopProgressPolling();
                        
                        if (data.progress === 100 && data.filename) {
                            // æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
                            downloadSection.style.display = 'block';
                            
                            // ä½¿ç”¨å®Œæ•´çš„URLè·¯å¾„
                            const baseUrl = window.location.origin;
                            const downloadUrl = `${baseUrl}/api/download/${taskId}`;
                            
                            downloadBtn.href = downloadUrl;
                            downloadBtn.download = data.filename;
                            downloadBtn.textContent = `ğŸ“¥ ä¸‹è½½ ${data.filename}`;
                            
                            logToConsole('ğŸ‰ è½¬æ¢å®Œæˆï¼ç‚¹å‡»ä¸‹è½½æŒ‰é’®è·å–æ–‡ä»¶', 'success');
                        } else {
                            logToConsole('âŒ è½¬æ¢å¤±è´¥', 'error');
                        }
                    }
                } catch (error) {
                    console.error('è·å–è¿›åº¦å¤±è´¥:', error);
                }
            }, 1000);
        }
        
        function stopProgressPolling() {
            if (progressInterval) {
                clearInterval(progressInterval);
                progressInterval = null;
            }
            conversionInProgress = false;
            convertBtn.disabled = false;
            btnText.textContent = 'ğŸš€ å¼€å§‹è½¬æ¢';
        }
        
        async function handleConversion() {
            if (!currentFile) {
                logToConsole('âŒ è¯·å…ˆé€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }
            
            if (conversionInProgress) {
                return;
            }
            
            // è·å–è¡¨å•æ•°æ®
            const width = document.getElementById('width').value || null;
            const height = document.getElementById('height').value || null;
            const selectedBlocks = Array.from(document.querySelectorAll('input[name="blocks"]:checked'))
                .map(checkbox => checkbox.value);
            const format = document.querySelector('input[name="format"]:checked').value;
            
            if (selectedBlocks.length === 0) {
                logToConsole('âŒ è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ–¹å—ç±»å‹', 'error');
                return;
            }
            
            // æ˜¾ç¤ºå¼€å§‹ä¿¡æ¯
            logToConsole('ğŸš€ å¼€å§‹è½¬æ¢æµç¨‹...', 'info');
            logToConsole(`ğŸ“¦ é€‰æ‹©çš„æ–¹å—ç±»å‹: ${selectedBlocks.join(', ')}`, 'info');
            logToConsole(`ğŸ“ è¾“å‡ºæ ¼å¼: .${format}`, 'info');
            if (width && height) {
                logToConsole(`ğŸ“ è®¾ç½®å°ºå¯¸: ${width} Ã— ${height} æ–¹å—`, 'info');
            } else {
                logToConsole('ğŸ“ ä½¿ç”¨åŸå›¾å°ºå¯¸', 'info');
            }
            
            try {
                // åˆ›å»º FormData
                const formData = new FormData();
                formData.append('image', currentFile);
                if (width) formData.append('width', width);
                if (height) formData.append('height', height);
                formData.append('format', format);
                selectedBlocks.forEach(block => formData.append('blocks[]', block));
                
                // å¼€å§‹è½¬æ¢
                const response = await fetch('/api/convert', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'è½¬æ¢å¤±è´¥');
                }
                
                // å¼€å§‹è½®è¯¢è¿›åº¦
                currentTaskId = result.task_id;
                startProgressPolling(currentTaskId);
                conversionInProgress = true;
                convertBtn.disabled = true;
                btnText.textContent = 'â³ è½¬æ¢ä¸­...';
                
                // éšè—ä¸‹è½½åŒºåŸŸ
                downloadSection.style.display = 'none';
                
            } catch (error) {
                logToConsole('âŒ è½¬æ¢é”™è¯¯: ' + error.message, 'error');
                conversionInProgress = false;
                convertBtn.disabled = false;
                btnText.textContent = 'ğŸš€ å¼€å§‹è½¬æ¢';
            }
        }
        
        function handleDownload(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (!downloadBtn.href || downloadBtn.href === '#') {
                logToConsole('âŒ ä¸‹è½½é“¾æ¥æ— æ•ˆ', 'error');
                return;
            }
            
            logToConsole('ğŸ“¥ æ­£åœ¨å‡†å¤‡ä¸‹è½½...', 'info');
            
            try {
                // æ–¹æ³•1: ä½¿ç”¨åˆ›å»ºä¸´æ—¶é“¾æ¥ä¸‹è½½ï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰
                const tempLink = document.createElement('a');
                tempLink.href = downloadBtn.href;
                tempLink.download = downloadBtn.download || 'structure.schem';
                tempLink.style.display = 'none';
                document.body.appendChild(tempLink);
                tempLink.click();
                
                // æ¸…ç†ä¸´æ—¶å…ƒç´ 
                setTimeout(() => {
                    document.body.removeChild(tempLink);
                    logToConsole('âœ… ä¸‹è½½å·²å¼€å§‹ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨ä¸‹è½½åˆ—è¡¨', 'success');
                }, 100);
                
                // æ–¹æ³•2: å¤‡ç”¨æ–¹æ¡ˆ - ä½¿ç”¨éšè—iframe
                setTimeout(() => {
                    downloadFrame.src = downloadBtn.href;
                }, 200);
                
            } catch (error) {
                logToConsole('âŒ ä¸‹è½½å¤±è´¥: ' + error.message, 'error');
                
                // æ–¹æ³•3: æœ€åçš„æ‰‹æ®µ - ç›´æ¥è·³è½¬
                window.location.href = downloadBtn.href;
            }
        }
        
        // åˆå§‹åŒ–æ§åˆ¶å°
        clearConsole();
    </script>
</body>
</html>